---
title: Visualizing Volcano Plots in R
author: Samuel David Gamboa-Tuz
date: '2020-08-09'
description: A short tutorial about how to make volcano plots in R.
slug: visualizing-volcano-plots-in-r
tags: 
  - Data visualization
  - R
  - Rstats
  - Gene expression
draft: no
highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

A **volcano plot** is a type of scatter plot commonly used to represent expression changes of thousands of genes between two samples or treatments. Typically, this kind of plots depict the **fold change**, positive or negative, in the x axis vs a **significance value**, such as the p-value or the adjusted p-value (FDR), in the y axis. Dots represent genes, and they can be labeled or colored according to some attribute, such as whether they are up- or down-regulated, a significance threshold, or an identifier.  

In this post I will give some examples on how to make volcano plots in **R** using **ggplot2** and some other packages from the **tidyverse**, such as **dplyr** and **tidyr**. I will also give an example on how to turn your R code into a **bash command** that can be used to make volcano plots from multiple data files at once. 

## Making a volcano plot

To make our volcano plots we will be using the tidyverse and ggrepel packages.

```{r Load packages, message=FALSE}
library(tidyverse)
library(ggrepel)
```


```{r Load data, message=FALSE}
my_data <- read_tsv("_files/L0_vs_L20.tsv")
my_data
```


Making the plot with ggplot2
```{r plot 1, fig.width=8, fig.align='center'}
my_plot1 <- ggplot(my_data, aes(logFC, -log(FDR,10))) +
  geom_point(size = 2/5) +
  xlab(expression("log"[2]*"FC")) + 
  ylab(expression("-log"[10]*"FDR")) +
  theme_bw()
my_plot1
```

## Adding color to up- and down-regulated genes

Now only up-regulated and down-regulated
```{r}
my_data <- my_data %>% 
  mutate(
    Expression = case_when(logFC >= log(2) & FDR <= 0.05 ~ "Up-regulated",
                           logFC <= -log(2) & FDR <= 0.05 ~ "Down-regulated",
                           TRUE ~ "Unchanged")
    )

my_data
```


Now plotting
```{r, fig.width=8, fig.align='center'}
my_plot2 <- ggplot(my_data, aes(logFC, -log(FDR,10))) +
  geom_point(aes(color = Expression), size = 2/5) +
  xlab(expression("log"[2]*"FC")) + 
  ylab(expression("-log"[10]*"FDR")) +
  theme_bw() +
  scale_color_manual(values = c("dodgerblue3", "gray50", "firebrick3")) +
  guides(colour = guide_legend(override.aes = list(size=1.5))) +
  theme(legend.title = element_blank())
my_plot2
```

## Adding labels with ggrepel

We are gonna get the top up- and down-regulated genes
```{r}
top <- 10
top_genes <- bind_rows(
  my_data %>% 
    filter(Expression == 'Up-regulated') %>% 
    arrange(FDR, desc(abs(logFC))) %>% 
    head(top),
  my_data %>% 
    filter(Expression == 'Down-regulated') %>% 
    arrange(FDR, desc(abs(logFC))) %>% 
    head(top)
)
top_genes
```


Now adding the labels

```{r, fig.width=8, fig.align='center'}
my_plot2 <-  my_plot2 +
  geom_label_repel(data = top_genes, mapping = aes(logFC, -log(FDR,10), label = Genes),
                   size = 2)
my_plot2

```

##  Adding counts to the legend
```{r}
my_data_exp_counts <- my_data %>% 
  group_by(Expression) %>% 
  summarise(Count = n())
my_data_exp_counts  
```
```{r}
up_genes <- format(my_data_exp_counts$Count[1], big.mark = ',')
unchanged_genes <- format(my_data_exp_counts$Count[2], big.mark = ',')
down_genes <- format(my_data_exp_counts$Count[3], big.mark = ',')
```

```{r, fig.width=9, fig.align='center'}
my_plot3 <- ggplot(my_data, aes(logFC, -log(FDR,10))) +
  geom_point(aes(color = Expression), size = 2/5) +
  xlab(expression("log"[2]*"FC")) + 
  ylab(expression("-log"[10]*"FDR")) +
  theme_bw() +
  scale_color_manual(labels = c(paste("Up-regulated (", up_genes, ")", sep = ""),
                                paste("Unchanged (", unchanged_genes, ")", sep = ""),
                                paste("Down-regulated (", down_genes, ")", sep = "")),
                     values = c("dodgerblue3", "gray50", "firebrick3") 
  ) +
  guides(colour = guide_legend(override.aes = list(size=1.5))) +
  theme(legend.title = element_blank()) +
  geom_label_repel(data = top_genes, mapping = aes(logFC, -log(FDR,10), label = Genes),
                   size = 2)
my_plot3
```




## Coloring by significance value

```{r Add Columns to data}
my_data <- my_data %>% 
  mutate(
    Significance = case_when(
      abs(logFC) >= log(2) & FDR <= 0.05 & FDR > 0.01 ~ "FDR 0.05", 
      abs(logFC) >= log(2) & FDR <= 0.01 & FDR > 0.001 ~ "FDR 0.01",
      abs(logFC) >= log(2) & FDR <= 0.001 ~ "FDR 0.001", 
      TRUE ~ "Unchanged")
  )
my_data
```

Let's known how any
```{r Generate counts}
my_data_exp_sig_counts <- my_data %>% 
  count(Expression, Significance)
my_data_exp_sig_counts  
```


```{r}

down001 <- format(my_data_exp_sig_counts[[3]][1], big.mark = ',')
down01 <- format(my_data_exp_sig_counts[[3]][2], big.mark = ',')
down05 <- format(my_data_exp_sig_counts[[3]][3], big.mark = ',')
unchanged <- format(my_data_exp_sig_counts[[3]][4], big.mark = ',')
up001 <- format(my_data_exp_sig_counts[[3]][5], big.mark = ',')
up01 <- format(my_data_exp_sig_counts[[3]][6], big.mark = ',')
up05 <- format(my_data_exp_sig_counts[[3]][7], big.mark = ',')


```

You can also embed plots, for example:

```{r Making the plot, fig.width=8, fig.align='center'}
my_plot4 <- ggplot(my_data, aes(logFC, -log(FDR,10))) +
  geom_point(aes(color = Significance), size = 2/5) +
  xlab(expression("log"[2]*"FC")) + 
  ylab(expression("-log"[10]*"FDR")) +
  theme_bw() +
  scale_color_manual(labels = c(paste("FDR 0.001\n","(",down001," / ",up001,")","\n", sep = ""),
                                paste("FDR 0.01\n","(",down01," / ",up01,")","\n", sep = ""),
                                paste("FDR 0.05\n","(",down05," / ",up05,")","\n", sep = ""),
                                paste("Unchanged\n","(",unchanged,")", sep = "")),
                     values = c("#980043", "#dd1c77", "#df65b0", "#d7b5d8")) +
  guides(colour = guide_legend(override.aes = list(size=1.5))) +
  theme(legend.title = element_blank()) +
  geom_label_repel(data = top_genes, mapping = aes(logFC, -log(FDR,10), label = Genes),
                   size = 2)
my_plot4
```
